---
import Lightbox from "../../components/gallery/Lightbox.astro";
import Gallery from "../../components/gallery/Gallery.astro";
import {
    fetchCollectionBySlug,
    fetchCollections,
    type CollectionFull,
} from "../../lib/api";
import type { Photo } from "../../lib/photos";

// Static generation: enumerate all collection slugs at build time
export async function getStaticPaths() {
    const API_BASE_URL =
        import.meta.env.PUBLIC_USE_LOCAL_BACKEND === "true"
            ? "http://localhost:8080"
            : import.meta.env.PUBLIC_API_BASE_URL;
    try {
        const list = await fetchCollections(API_BASE_URL);
        return list.map((c) => ({ params: { slug: c.slug } }));
    } catch (e) {
        console.error("getStaticPaths collections fetch failed", e);
        return [];
    }
}

const { slug } = Astro.params;
let collection: CollectionFull | null = null;
let photos: Photo[] = [];
const baseURL = import.meta.env.PUBLIC_IMAGE_BASE_URL;
try {
    const API_BASE_URL =
        import.meta.env.PUBLIC_USE_LOCAL_BACKEND === "true"
            ? "http://localhost:8080"
            : import.meta.env.PUBLIC_API_BASE_URL;
    collection = await fetchCollectionBySlug(API_BASE_URL, slug!);
    photos = collection.photos;
} catch (e) {
    console.error("Collection fetch failed", e);
}
---

{
    collection ? (
        <article class="max-w-5xl mx-auto px-4 py-6">
            <header class="mb-6">
                <h1 class="text-3xl font-semibold mb-2">{collection.title}</h1>
                {collection.description && (
                    <p class="text-zinc-300 leading-relaxed mb-2">
                        {collection.description}
                    </p>
                )}
                {collection.note && (
                    <p class="text-sm text-zinc-500 italic">
                        {collection.note}
                    </p>
                )}
            </header>
            <Gallery photos={photos} baseURL={baseURL} />
            <Lightbox photos={photos} baseURL={baseURL} />
        </article>
    ) : (
        <p class="max-w-xl mx-auto px-4 py-12 text-center text-zinc-400">
            Collection not found or temporarily unavailable.
        </p>
    )
}
