---
import Footer from "../components/Footer.astro";
import "../styles/global.css";
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="24x24"
            href="/favicon-24.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32.png"
        />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>Contact | Ráquira</title>
        <!-- Google Fonts preconnect for performance -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <!-- Selected fonts: Poppins for headers, Inter for body -->
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>
    <body class="bg-zinc-950 p-8" style="font-family: 'Inter', sans-serif;">
        <h1
            class="text-red-50 text-5xl md:text-7xl lg:text-8xl font-bold mb-8"
            style="font-family: 'Poppins', sans-serif;"
        >
            <a href="/" class="hover:text-zinc-300 transition-colors">Ráquira</a
            >
        </h1>

        <div class="max-w-2xl mx-auto">
            <!-- Success View (hidden by default) -->
            <div id="successView" class="hidden text-center py-12">
                <div class="mb-8">
                    <svg
                        class="w-20 h-20 mx-auto text-green-500 mb-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    <h2
                        class="text-zinc-100 text-3xl md:text-4xl font-semibold mb-4"
                        style="font-family: 'Poppins', sans-serif;"
                    >
                        Message Sent!
                    </h2>
                    <p class="text-zinc-400 text-lg">
                        Thank you for reaching out. We'll get back to you soon.
                    </p>
                </div>
                <a
                    href="/"
                    class="inline-flex items-center gap-2 px-8 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 hover:border-zinc-500 rounded-lg text-zinc-100 font-medium transition-all duration-200 hover:scale-105"
                    style="font-family: 'Poppins', sans-serif;"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                        ></path>
                    </svg>
                    Back to Home
                </a>
            </div>

            <!-- Form View (visible by default) -->
            <div id="formView">
                <h2
                    class="text-zinc-100 text-3xl md:text-4xl font-semibold mb-4"
                    style="font-family: 'Poppins', sans-serif;"
                >
                    Get in Touch
                </h2>
                <p class="text-zinc-400 text-lg mb-8">
                    Have a question or comment? Send us a message.
                </p>

                <!-- Error Messages -->
                <div
                    id="errorMessage"
                    class="hidden mb-6 p-4 rounded-lg bg-red-900/30 border border-red-700"
                    role="alert"
                >
                    <p id="errorText" class="text-red-400"></p>
                </div>

                <form id="contactForm" class="space-y-6">
                    <!-- Honeypot field (hidden from users) -->
                    <input
                        type="text"
                        name="company"
                        id="company"
                        style="display: none"
                        tabindex="-1"
                        autocomplete="off"
                        aria-hidden="true"
                    />

                    <!-- Name field -->
                    <div>
                        <label
                            for="name"
                            class="block text-zinc-300 text-sm font-medium mb-2"
                        >
                            Name
                        </label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            maxlength="200"
                            class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-transparent transition-all"
                            placeholder="Your name"
                        />
                    </div>

                    <!-- Email field -->
                    <div>
                        <label
                            for="email"
                            class="block text-zinc-300 text-sm font-medium mb-2"
                        >
                            Email <span class="text-red-400">*</span>
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            maxlength="200"
                            class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-transparent transition-all"
                            placeholder="your.email@example.com"
                        />
                    </div>

                    <!-- Message field -->
                    <div>
                        <label
                            for="message"
                            class="block text-zinc-300 text-sm font-medium mb-2"
                        >
                            Message <span class="text-red-400">*</span>
                        </label>
                        <textarea
                            id="message"
                            name="message"
                            required
                            maxlength="5000"
                            rows="6"
                            class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-transparent transition-all resize-y"
                            placeholder="Your message..."></textarea>
                        <p class="text-zinc-500 text-sm mt-1">
                            <span id="charCount">0</span> / 5000 characters
                        </p>
                    </div>

                    <!-- Submit button -->
                    <div class="flex items-center gap-4">
                        <button
                            type="submit"
                            id="submitBtn"
                            class="px-8 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 hover:border-zinc-500 rounded-lg text-zinc-100 font-medium transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                            style="font-family: 'Poppins', sans-serif;"
                        >
                            Send Message
                        </button>
                        <div
                            id="spinner"
                            class="hidden w-6 h-6 border-2 border-zinc-700 border-t-zinc-400 rounded-full animate-spin"
                        >
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-16">
            <Footer />
        </div>

        <script>
            const form = document.getElementById(
                "contactForm",
            ) as HTMLFormElement;
            const submitBtn = document.getElementById(
                "submitBtn",
            ) as HTMLButtonElement;
            const formView = document.getElementById("formView") as HTMLElement;
            const successView = document.getElementById(
                "successView",
            ) as HTMLElement;
            const errorMessage = document.getElementById(
                "errorMessage",
            ) as HTMLElement;
            const errorText = document.getElementById(
                "errorText",
            ) as HTMLElement;
            const spinner = document.getElementById("spinner") as HTMLElement;
            const messageField = document.getElementById(
                "message",
            ) as HTMLTextAreaElement;
            const charCount = document.getElementById(
                "charCount",
            ) as HTMLElement;

            // Character counter
            messageField.addEventListener("input", () => {
                charCount.textContent = messageField.value.length.toString();
            });

            // Form submission handler
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                // Get form data
                const formData = new FormData(form);
                const company = formData.get("company") as string;
                const name = formData.get("name") as string;
                const email = formData.get("email") as string;
                const message = formData.get("message") as string;

                // Honeypot check - if filled, silently "succeed" without sending
                if (company && company.trim() !== "") {
                    showSuccess();
                    return;
                }

                // Client-side validation
                if (!email || !message) {
                    showError("Please fill in all required fields.");
                    return;
                }

                if (
                    email.length > 200 ||
                    message.length > 5000 ||
                    (name && name.length > 200)
                ) {
                    showError("One or more fields exceed maximum length.");
                    return;
                }

                // Basic email format check
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError("Please enter a valid email address.");
                    return;
                }

                // Disable form and show spinner
                submitBtn.disabled = true;
                spinner.classList.remove("hidden");
                hideError();

                try {
                    const response = await fetch(
                        "https://api.raquira.org/contact",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                name: name || undefined,
                                email: email,
                                message: message,
                            }),
                        },
                    );

                    if (response.ok) {
                        showSuccess();
                    } else if (response.status === 429) {
                        showError(
                            "Too many requests. Please wait a moment and try again.",
                        );
                    } else if (response.status === 400) {
                        const errorText = await response.text();
                        showError(
                            errorText ||
                                "Invalid form data. Please check your inputs.",
                        );
                    } else {
                        showError("Server error. Please try again later.");
                    }
                } catch (error) {
                    showError(
                        "Network error. Please check your connection and try again.",
                    );
                } finally {
                    // Re-enable form
                    submitBtn.disabled = false;
                    spinner.classList.add("hidden");
                }
            });

            function showSuccess() {
                // Hide form view, show success view
                formView.classList.add("hidden");
                successView.classList.remove("hidden");

                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: "smooth" });
            }

            function showError(message: string) {
                errorText.textContent = message;
                errorMessage.classList.remove("hidden");

                // Scroll to error message
                errorMessage.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                });
            }

            function hideError() {
                errorMessage.classList.add("hidden");
            }
        </script>
    </body>
</html>
