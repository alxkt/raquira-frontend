---
import Footer from "../components/Footer.astro";
import "../styles/global.css";
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="/favicon-16.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="24x24"
			href="/favicon-24.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="/favicon-32.png"
		/>
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Contact | Ráquira</title>
		<!-- Google Fonts preconnect for performance -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

		<!-- Selected fonts: Poppins for headers, Inter for body -->
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body class="bg-zinc-950 p-8" style="font-family: 'Inter', sans-serif;">
		<h1
			class="text-red-50 text-5xl md:text-7xl lg:text-8xl font-bold mb-8"
			style="font-family: 'Poppins', sans-serif;"
		>
			<a href="/" class="hover:text-zinc-300 transition-colors">Ráquira</a>
		</h1>

		<div class="max-w-2xl mx-auto">
			<h2
				class="text-zinc-100 text-3xl md:text-4xl font-semibold mb-4"
				style="font-family: 'Poppins', sans-serif;"
			>
				Get in Touch
			</h2>
			<p class="text-zinc-400 text-lg mb-8">
				Have a question or comment? Send us a message.
			</p>

			<!-- Status Messages -->
			<div
				id="statusMessage"
				class="hidden mb-6 p-4 rounded-lg"
				role="alert"
			>
				<p id="statusText"></p>
			</div>

			<form id="contactForm" class="space-y-6">
				<!-- Honeypot field (hidden from users) -->
				<input
					type="text"
					name="company"
					id="company"
					style="display: none"
					tabindex="-1"
					autocomplete="off"
					aria-hidden="true"
				/>

				<!-- Name field -->
				<div>
					<label
						for="name"
						class="block text-zinc-300 text-sm font-medium mb-2"
					>
						Name
					</label>
					<input
						type="text"
						id="name"
						name="name"
						maxlength="200"
						class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-transparent transition-all"
						placeholder="Your name"
					/>
				</div>

				<!-- Email field -->
				<div>
					<label
						for="email"
						class="block text-zinc-300 text-sm font-medium mb-2"
					>
						Email <span class="text-red-400">*</span>
					</label>
					<input
						type="email"
						id="email"
						name="email"
						required
						maxlength="200"
						class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-transparent transition-all"
						placeholder="your.email@example.com"
					/>
				</div>

				<!-- Message field -->
				<div>
					<label
						for="message"
						class="block text-zinc-300 text-sm font-medium mb-2"
					>
						Message <span class="text-red-400">*</span>
					</label>
					<textarea
						id="message"
						name="message"
						required
						maxlength="5000"
						rows="6"
						class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-transparent transition-all resize-y"
						placeholder="Your message..."
					></textarea>
					<p class="text-zinc-500 text-sm mt-1">
						<span id="charCount">0</span> / 5000 characters
					</p>
				</div>

				<!-- Submit button -->
				<div class="flex items-center gap-4">
					<button
						type="submit"
						id="submitBtn"
						class="px-8 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 hover:border-zinc-500 rounded-lg text-zinc-100 font-medium transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
						style="font-family: 'Poppins', sans-serif;"
					>
						Send Message
					</button>
					<div
						id="spinner"
						class="hidden w-6 h-6 border-2 border-zinc-700 border-t-zinc-400 rounded-full animate-spin"
					>
					</div>
				</div>
			</form>
		</div>

		<div class="mt-16">
			<Footer />
		</div>

		<script>
			const form = document.getElementById(
				"contactForm"
			) as HTMLFormElement;
			const submitBtn = document.getElementById(
				"submitBtn"
			) as HTMLButtonElement;
			const spinner = document.getElementById("spinner") as HTMLElement;
			const statusMessage = document.getElementById(
				"statusMessage"
			) as HTMLElement;
			const statusText = document.getElementById(
				"statusText"
			) as HTMLElement;
			const messageField = document.getElementById(
				"message"
			) as HTMLTextAreaElement;
			const charCount = document.getElementById(
				"charCount"
			) as HTMLElement;

			// Character counter
			messageField.addEventListener("input", () => {
				charCount.textContent = messageField.value.length.toString();
			});

			// Form submission handler
			form.addEventListener("submit", async (e) => {
				e.preventDefault();

				// Get form data
				const formData = new FormData(form);
				const company = formData.get("company") as string;
				const name = formData.get("name") as string;
				const email = formData.get("email") as string;
				const message = formData.get("message") as string;

				// Honeypot check - if filled, silently "succeed" without sending
				if (company && company.trim() !== "") {
					showSuccess();
					form.reset();
					charCount.textContent = "0";
					return;
				}

				// Client-side validation
				if (!email || !message) {
					showError("Please fill in all required fields.");
					return;
				}

				if (email.length > 200 || message.length > 5000 || (name && name.length > 200)) {
					showError("One or more fields exceed maximum length.");
					return;
				}

				// Basic email format check
				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailRegex.test(email)) {
					showError("Please enter a valid email address.");
					return;
				}

				// Disable form and show spinner
				submitBtn.disabled = true;
				spinner.classList.remove("hidden");
				hideStatus();

				try {
					const response = await fetch(
						"https://api.raquira.org/contact",
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								name: name || undefined,
								email: email,
								message: message,
							}),
						}
					);

					if (response.ok) {
						const data = await response.json();
						if (data.ok) {
							showSuccess();
							form.reset();
							charCount.textContent = "0";
						} else {
							showError("Failed to send message. Please try again.");
						}
					} else if (response.status === 429) {
						showError(
							"Too many requests. Please wait a moment and try again."
						);
					} else if (response.status === 400) {
						const errorText = await response.text();
						showError(errorText || "Invalid form data. Please check your inputs.");
					} else {
						showError(
							"Server error. Please try again later."
						);
					}
				} catch (error) {
					showError(
						"Network error. Please check your connection and try again."
					);
				} finally {
					// Re-enable form
					submitBtn.disabled = false;
					spinner.classList.add("hidden");
				}
			});

			function showSuccess() {
				statusMessage.className =
					"mb-6 p-4 rounded-lg bg-green-900/30 border border-green-700";
				statusText.className = "text-green-400";
				statusText.textContent =
					"Message sent successfully! We'll get back to you soon.";
				statusMessage.classList.remove("hidden");
				
				// Scroll to message
				statusMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
			}

			function showError(message: string) {
				statusMessage.className =
					"mb-6 p-4 rounded-lg bg-red-900/30 border border-red-700";
				statusText.className = "text-red-400";
				statusText.textContent = message;
				statusMessage.classList.remove("hidden");
				
				// Scroll to message
				statusMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
			}

			function hideStatus() {
				statusMessage.classList.add("hidden");
			}
		</script>
	</body>
</html>
